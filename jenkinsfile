pipeline {
  agent any
  stages {
    stage('Git Update') {
      steps {
        cleanWs()
        script {
          checkout([$class: 'GitSCM', branches: [
            [name: '*/main']
          ], extensions: [
            [$class: 'CloneOption', depth: 1000000, noTags: false, reference: '', shallow: true]
          ], userRemoteConfigs: [
            [url: 'https://github.com/kolmafia/kolmafia']
          ]])
        }
      }
    }
    stage('Building') {
      steps {
        script {
          withEnv(["JAVA_HOME=/usr/lib/jvm/adoptopenjdk-16-hotspot-amd64"]) {
            sh 'ls'
            sh 'java --version'
            sh './gradlew -v'
            sh './gradlew --no-daemon clean shadowJar'
          }
        }
      }
    }
    stage('Testing') {
      steps {
        script {
          withEnv(["JAVA_HOME=/usr/lib/jvm/adoptopenjdk-16-hotspot-amd64"]) {
            sh './gradlew --no-daemon --stacktrace jacocoTestReport'
            step([
              $class: 'JacocoPublisher',
              reportDir: 'build/reports/jacoco/test',
              reportFileName: 'jacocoTestReport.xml',
              healthyTarget: [methodCoverage: 70, conditionalCoverage: 70, statementCoverage: 70],
              unhealthyTarget: [methodCoverage: 50, conditionalCoverage: 50, statementCoverage: 50],
              failingTarget: [methodCoverage: 0, conditionalCoverage: 0, statementCoverage: 0]
            ])
            publishHTML([
              allowMissing: true,
              alwaysLinkToLastBuild: false,
              keepAll: true,
              reportDir: 'build/reports/tests/test',
              reportFiles: 'index.html',
              reportName: 'JaCoCo Test Report'
            ])
          }
        }
      }
    }
    stage('Archiving') {
      steps {
        script {
          archiveArtifacts 'dist/*.jar'
        }
      }
    }
  }
}
